{
    "name": "06 - GPU Execution Pipeline (Phase 2)",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "exec-gpu-job",
                "options": {}
            },
            "id": "webhook-gpu",
            "name": "Webhook (Approve GPU)",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "=SELECT * FROM nsfw_content WHERE id = {{ $json.body.id }} LIMIT 1",
                "options": {}
            },
            "id": "fetch-proposal",
            "name": "Fetch Proposal DB",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.4,
            "position": [
                450,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "waifugen_postgres",
                    "name": "WaifuGen PostgreSQL"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "return {\n  job_payload: {\n    id: $input.item.json.id,\n    character: $input.item.json.character,\n    prompt: $input.item.json.prompt,\n    duration: 60,\n    gpu: 'RTX_4090',\n    provider: 'runpod',\n    aesthetic: 'amateur_realism'\n  }\n};"
            },
            "id": "prepare-job",
            "name": "Prepare GPU Job",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "command": "python src/processing/n8n_long_video_bridge.py '{{ JSON.stringify($json.job_payload) }}'"
            },
            "id": "execute-gpu",
            "name": "Execute RunPod GPU Job",
            "type": "n8n-nodes-base.executeCommand",
            "typeVersion": 1,
            "position": [
                850,
                300
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "=UPDATE nsfw_content SET status = 'completed', video_url = '{{ ($json.output_path || 's3://bucket/placeholder.mp4').replace(/'/g, \"''\") }}' WHERE id = {{ $('Prepare GPU Job').item.json.job_payload.id }}",
                "options": {}
            },
            "id": "update-db",
            "name": "Update DB Status",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.4,
            "position": [
                1050,
                300
            ],
            "credentials": {
                "postgres": {
                    "id": "waifugen_postgres",
                    "name": "WaifuGen PostgreSQL"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.TELEGRAM_BOT_URL }}/sendMessage",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "chat_id",
                            "value": "={{ $env.TELEGRAM_ADMIN_CHAT_ID }}"
                        },
                        {
                            "name": "text",
                            "value": "=âœ… <b>GPU Job Completed</b>\n\nContent ID: {{ $('Prepare GPU Job').item.json.job_payload.id }}\nURL: {{ $json.video_url || 'Available in S3' }}\n\nReady for distribution."
                        },
                        {
                            "name": "parse_mode",
                            "value": "HTML"
                        }
                    ]
                },
                "options": {}
            },
            "id": "notify-success",
            "name": "Notify Success",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1250,
                300
            ]
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "reject-gpu-job",
                "options": {}
            },
            "id": "webhook-gpu-reject",
            "name": "Webhook (Reject GPU)",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [
                250,
                150
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "=UPDATE nsfw_content SET status = 'rejected' WHERE id = {{ $json.body.id }}",
                "options": {}
            },
            "id": "update-gpu-db-reject",
            "name": "Update DB Status Reject",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.4,
            "position": [
                450,
                150
            ],
            "credentials": {
                "postgres": {
                    "id": "waifugen_postgres",
                    "name": "WaifuGen PostgreSQL"
                }
            }
        }
    ],
    "connections": {
        "Webhook (Approve GPU)": {
            "main": [
                [
                    {
                        "node": "Fetch Proposal DB",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Proposal DB": {
            "main": [
                [
                    {
                        "node": "Prepare GPU Job",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare GPU Job": {
            "main": [
                [
                    {
                        "node": "Execute RunPod GPU Job",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute RunPod GPU Job": {
            "main": [
                [
                    {
                        "node": "Update DB Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update DB Status": {
            "main": [
                [
                    {
                        "node": "Notify Success",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook (Reject GPU)": {
            "main": [
                [
                    {
                        "node": "Update DB Status Reject",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
}